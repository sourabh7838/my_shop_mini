{"version":3,"file":"ImagePickerProvider.js","sources":["../../src/providers/ImagePickerProvider.tsx"],"sourcesContent":["import React, {\n  createContext,\n  useContext,\n  useRef,\n  useCallback,\n  useEffect,\n  useMemo,\n} from 'react'\n\nexport type CameraFacing = 'front' | 'back'\n\ninterface ImagePickerContextValue {\n  openCamera: (cameraFacing?: CameraFacing) => Promise<File>\n  openGallery: () => Promise<File>\n}\n\nconst ImagePickerContext = createContext<ImagePickerContextValue | null>(null)\n\nexport function useImagePickerContext() {\n  const context = useContext(ImagePickerContext)\n  if (!context) {\n    throw new Error(\n      'useImagePickerContext must be used within an ImagePickerProvider'\n    )\n  }\n  return context\n}\n\ninterface ImagePickerProviderProps {\n  children: React.ReactNode\n}\n\nexport function ImagePickerProvider({children}: ImagePickerProviderProps) {\n  const galleryInputRef = useRef<HTMLInputElement>(null)\n  const frontCameraInputRef = useRef<HTMLInputElement>(null)\n  const backCameraInputRef = useRef<HTMLInputElement>(null)\n  const resolveRef = useRef<((file: File) => void) | null>(null)\n  const rejectRef = useRef<((reason: Error) => void) | null>(null)\n  const activeCancelHandlerRef = useRef<{\n    input: HTMLInputElement\n    handler: () => void\n  } | null>(null)\n\n  const cleanupCancelHandler = useCallback(() => {\n    if (activeCancelHandlerRef.current) {\n      const {input, handler} = activeCancelHandlerRef.current\n      input.removeEventListener('cancel', handler)\n      activeCancelHandlerRef.current = null\n    }\n  }, [])\n\n  const rejectPendingPromise = useCallback(() => {\n    if (rejectRef.current) {\n      rejectRef.current(\n        new Error('New file picker opened before previous completed')\n      )\n      resolveRef.current = null\n      rejectRef.current = null\n    }\n  }, [])\n\n  const handleFileChange = useCallback(\n    (event: React.ChangeEvent<HTMLInputElement>) => {\n      const file = event.target.files?.[0]\n\n      if (file && resolveRef.current) {\n        resolveRef.current(file)\n\n        resolveRef.current = null\n        rejectRef.current = null\n\n        cleanupCancelHandler()\n      }\n\n      event.target.value = ''\n    },\n    [cleanupCancelHandler]\n  )\n\n  const openGallery = useCallback(() => {\n    return new Promise<File>((resolve, reject) => {\n      rejectPendingPromise()\n      cleanupCancelHandler()\n\n      resolveRef.current = resolve\n      rejectRef.current = reject\n\n      const input = galleryInputRef.current\n\n      if (!input) {\n        reject(new Error('Gallery input not found'))\n        resolveRef.current = null\n        rejectRef.current = null\n        return\n      }\n\n      const handleCancel = () => {\n        if (rejectRef.current) {\n          rejectRef.current(new Error('User cancelled file selection'))\n          resolveRef.current = null\n          rejectRef.current = null\n        }\n        cleanupCancelHandler()\n      }\n\n      input.addEventListener('cancel', handleCancel)\n      activeCancelHandlerRef.current = {input, handler: handleCancel}\n\n      input.click()\n    })\n  }, [rejectPendingPromise, cleanupCancelHandler])\n\n  const openCamera = useCallback(\n    (cameraFacing: CameraFacing = 'back') => {\n      return new Promise<File>((resolve, reject) => {\n        rejectPendingPromise()\n        cleanupCancelHandler()\n\n        resolveRef.current = resolve\n        rejectRef.current = reject\n\n        const input =\n          cameraFacing === 'front'\n            ? frontCameraInputRef.current\n            : backCameraInputRef.current\n\n        if (!input) {\n          reject(new Error('Camera input not found'))\n          resolveRef.current = null\n          rejectRef.current = null\n          return\n        }\n\n        const handleCancel = () => {\n          if (rejectRef.current) {\n            rejectRef.current(new Error('User cancelled camera'))\n            resolveRef.current = null\n            rejectRef.current = null\n          }\n          cleanupCancelHandler()\n        }\n\n        input.addEventListener('cancel', handleCancel)\n        activeCancelHandlerRef.current = {input, handler: handleCancel}\n\n        input.click()\n      })\n    },\n    [rejectPendingPromise, cleanupCancelHandler]\n  )\n\n  useEffect(() => {\n    return () => {\n      rejectPendingPromise()\n      cleanupCancelHandler()\n    }\n  }, [rejectPendingPromise, cleanupCancelHandler])\n\n  const contextValue: ImagePickerContextValue = useMemo(\n    () => ({\n      openCamera,\n      openGallery,\n    }),\n    [openCamera, openGallery]\n  )\n\n  return (\n    <ImagePickerContext.Provider value={contextValue}>\n      {children}\n      <input\n        ref={galleryInputRef}\n        type=\"file\"\n        accept=\"image/*\"\n        onChange={handleFileChange}\n        style={{display: 'none'}}\n        aria-hidden=\"true\"\n      />\n      <input\n        ref={frontCameraInputRef}\n        type=\"file\"\n        accept=\"image/*\"\n        capture=\"user\"\n        onChange={handleFileChange}\n        style={{display: 'none'}}\n        aria-hidden=\"true\"\n      />\n      <input\n        ref={backCameraInputRef}\n        type=\"file\"\n        accept=\"image/*\"\n        capture=\"environment\"\n        onChange={handleFileChange}\n        style={{display: 'none'}}\n        aria-hidden=\"true\"\n      />\n    </ImagePickerContext.Provider>\n  )\n}\n"],"names":["ImagePickerContext","createContext","useImagePickerContext","context","useContext","ImagePickerProvider","children","galleryInputRef","useRef","frontCameraInputRef","backCameraInputRef","resolveRef","rejectRef","activeCancelHandlerRef","cleanupCancelHandler","useCallback","input","handler","rejectPendingPromise","handleFileChange","event","file","openGallery","resolve","reject","handleCancel","openCamera","cameraFacing","useEffect","contextValue","useMemo","jsxs","jsx"],"mappings":"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"}