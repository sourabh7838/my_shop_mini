# Shop minis CLI

The CLI tool to create, run and publish minis.

## Getting started

_If you want to read on how to use the CLI, jump to [using the cli](#using-the-cli) section_

### Set up

1. Clone the repository with `dev clone shop-minis-cli`
2. Install dependencies: `yarn`

### Development

When working with templates or the create mini command, you can easily test your local changes by creating a new mini running `yarn build:cli && yarn shop-minis create`.

However, testing changes on the dev command gets more complicated because newly created minis get the CLI as a dependency from npm instead of using our local version with the changes we want to test. Follow instructions below to link a mini to your local CLI:

1. In the CLI folder, run `yarn link`.
2. In your mini (create a new mini if you don't have a mini already), run `yarn link @shopify/shop-minis-cli`
3. Whenever you change something in the CLI, run `yarn build`.
4. Rerun `yarn start` in the mini, the command should reflect the latest changes you did in the CLI project.

#### Installing dependencies

Use `yarn`, don't create or commit an npm `package-lock.json`. `yarn.lock` is the source of truth.

### Testing changes with snapshot releases

`yarn link` helps us a lot when testing changes to CLI locally, but there are edge cases where symbolic links interfere with the functionality we are actually trying to test.

In those cases, you can create an snapshot release:

1. checkout the snapshot branch: `git checkout -b snapshot origin/snapshot`
2. the branch might be old and stale, so reset it to the latest main: `git reset --hard origin/main`
3. bring your changes to this branch via `git merge`, `git rebase`, `git cherry-pick` or whatever method you prefer
4. push the branch and the tag: `git push origin snapshot` (you may need to use the `--force`)
5. run the shipit deployment in [Shipit shop-minis-cli/snapshot](https://shipit.shopify.io/shopify/shop-minis-cli/snapshot) (Ignore the message about bumping the version - we use a timestamp for the version like `0.0.0-snapshot.20240910122838`)
6. install the snapshot version in the mini you want to use to test the new changes of the CLI
7. test it!
8. if more changes are needed, include them in the snapshot branch, push and redeploy

snapshot versions are released to npm with the tag `snapshot`, so they won't be installed by partners unless they explicitly use the tag (`npm install @shopify/shop-minis-cli@snapshot`)

## Using the CLI

To use the CLI create a new mini: `yarn create @shopify/shop-mini`

Then use `yarn shop-minis --help` to get instructions on how to use the CLI.

## Creating a new release

1. Check out and pull the latest `main` branch.
2. Run `yarn version --patch`.
3. Push both the version bump commit and the tag `git push origin main --follow-tags`
4. In [shipit](https://shipit.shopify.io/shopify/shop-minis-cli/production), find the commit corresponding to the new release and deploy it.
5. After the deploy succeeds, the new version should be published in the [npm public registry](https://www.npmjs.com/package/@shopify/shop-minis-cli) and ready to be used.

## Sharing snapshot builds with partners

If you need to share a snapshot build with a partner, follow these steps.

1. Follow [these docs](https://shop.docs.shopify.io/docs/shop-client/tophatting#manually-triggering-snapshot-builds) to manually create the snapshot build from the branch you want to share with the partner (use `main` as the branch if the change you want to share is already merged)
2. When the snapshot build is ready, take note of the version and build number. (In shipit, snapshot builds are usually named `<version>-snapshot.<build number>`, example: `2.45.0-snapshot.1645678813`)
3. Instruct the partner to run the mini, adding `--snapshot-version <version>+<build number>` to the start command. Example: `yarn start --snapshot-version 2.108.1+1685260045` or `npm start -- --snapshot-version 2.108.1+1685260045`

Using this argument should download a new Shop binary in the partner's device. Note that android and iOSÂ snapshots will have different build numbers, so check with the partner which platform they want to use.

## Codemods

If some changes in the SDK or CLI require changes to the way we run minis you might need a codemod for the next version.

Imagine `shop-minis-cli` is currently on `v0.0.74`. You will be creating the codemod for `v0.0.75`

- Before making any changes checkout `v0.0.74`, run a cli build and create a mini.
- Optional: Set up git for the mini and make an initial commit. This will allow you to reset the state later.
- Create `src/commands/codemod/releases/v0-0-75.ts`. Copying the previous codemod will ensure you get the right format
- Add your codemod to `src/commands/codemod/releases/index.ts`
- [Run the cli and link your mini](#development)
- Make your changes
- Run `yarn shop-minis codemod --from-version 0.0.74 --to-version 0.0.75 --no-hard-reset-dependencies --verbose` to test your changes
- Use the git diff to decide if your codemod worked as expected. Also verify your test mini still runs as expected.
- Use git reset, make changes and re-run the codemod until it works as expected
- When everything works as expected send a PR with the changes.
- Ensure this PR gets merged before `v0.0.75` is tagged/released. If someone tags/releases `v0.0.75` before your change lands you will need to rename your codemod to be the next version. This is because once cli users have upgraded to `v0.0.75` this codemod will never be run if it is merged and included in a later release

### Codemod testing

You can add unit tests for each codemod if required. Each codemod will also be validated by CI. The CI tests work as follows:

- Mini A is created with the latest CLI
- Mini B is created with CLI v0.0.42 (The first version supported by codemods)
- Mini B is upgraded by running all the codemods
- The expectation is that Mini B equals Mini A (old mini + codemods === new mini)

See [upgrade_command_integration.yml](.github/workflows/upgrade_command_integration.yml) and [an example run](https://github.com/Shopify/shop-minis-cli/actions/runs/5544190658/jobs/10121293912?pr=306) for details.

### Troubleshooting

#### Making sure the partner is using the right version

To make sure the partner is using the right version, you can ask them to provide a screenshot of the About screen of the app (Profile tab -> Support -> About)

The version shown in the screen should match the snapshot version you handled them.

#### Making sure the partner build exists

All partner builds are uploaded to a bucket in google cloud. If you created a snapshot, there should be a partner build in [this bucket](https://console.cloud.google.com/storage/browser/minis_cli_app_builds;tab=objects?project=arrive-167720&prefix=&forceOnObjectsSortingFiltering=false) matching the version of the snapshot.

If you can't find your build, try looking for errors in the pipelines that create these builds:

- Pipeline for iOS: https://buildkite.com/shopify/shipit-mobile-shop-ios-minis-partner-build
- Pipeline for Android: https://buildkite.com/shopify/shipit-mobile-shop-android-minis-partner-build
