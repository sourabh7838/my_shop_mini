import { readFile, writeFile } from 'node:fs/promises';
import path from 'node:path';
import { SemVer } from 'semver';
import { getRunBinCommand } from '../../../utils/package-manager.js';
import { execAsync } from '../../../utils/exec-async-child-process.js';
/**
 * Updates the index file to consider that now partners may use ViewerRoot in their mini app config
 *
 * Diff: https://github.com/Shopify/shop-minis-cli/compare/v0.0.99...v0.0.100
 */
async function applyUpgrade() {
    const indexTsxPath = path.join(process.cwd(), 'index.tsx');
    const srcIndexTsxPath = path.join(process.cwd(), 'src', 'index.tsx');
    try {
        // add reference to MiniApp.ViewerRoot in the root index.tsx
        // we get tsc errors otherwise
        const indexTsxContent = await readFile(indexTsxPath, {
            encoding: 'utf-8',
        });
        const newIndexTsxContent = indexTsxContent.replace('renderDevelopmentMini(MiniApp.Root,', 'renderDevelopmentMini(MiniApp.Root || MiniApp.ViewerRoot,');
        await writeFile(indexTsxPath, newIndexTsxContent, {
            encoding: 'utf-8',
        });
        // replace Root: in the mini app config definition with ViewerRoot:
        const srcIndexTsxContent = await readFile(srcIndexTsxPath, {
            encoding: 'utf-8',
        });
        const newSrcIndexTsxContent = srcIndexTsxContent.replace('Root:', 'ViewerRoot:');
        await writeFile(srcIndexTsxPath, newSrcIndexTsxContent, {
            encoding: 'utf-8',
        });
        const prettierCmd = await getRunBinCommand(`prettier -w ${indexTsxPath} ${srcIndexTsxContent}`);
        await execAsync({
            cmd: prettierCmd,
        });
    }
    catch (error) {
        // If index.tsx or src/index doesn't exist or is unreadable for some reason, we don't need to do anything
    }
}
const releaseNotes = [
    'Remove usage of deprecated Root attribute in MiniAppConfig in favour of ViewerRoot',
];
const exports = {
    releaseNotes,
    applyUpgrade,
    version: new SemVer('0.0.100'),
};
export default exports;
//# sourceMappingURL=v0-0-100.js.map