import path from 'node:path';
import fs from 'node:fs';
import { SemVer } from 'semver';
/**
 * Upgrade @shopify/shop-minis-runtime
 * Replace custom babel config with minis preset
 * Replace custom metro config with minis metro config
 * Remove dependencies that became unused after moving metro and babel config to the runtime package
 * Remove other dependencies moved to the runtime package
 *
 * Diff: https://github.com/Shopify/shop-minis-cli/compare/v0.0.57...v0.0.58
 */
async function applyUpgrade() {
    const packageJsonPath = path.join(process.cwd(), 'package.json');
    const packageJsonString = fs.readFileSync(packageJsonPath, {
        encoding: 'utf-8',
    });
    const packageJson = JSON.parse(packageJsonString) || {};
    packageJson.devDependencies ||= {};
    packageJson.dependencies ||= {};
    packageJson.dependencies['@shopify/shop-minis-runtime'] = '^0.0.8';
    delete packageJson.devDependencies['@babel/core'];
    delete packageJson.devDependencies['@babel/plugin-transform-named-capturing-groups-regex'];
    delete packageJson.devDependencies['@babel/plugin-transform-react-jsx'];
    delete packageJson.devDependencies['@babel/runtime'];
    delete packageJson.devDependencies['babel-plugin-import-graphql'];
    delete packageJson.devDependencies.graphql;
    delete packageJson.devDependencies['metro-react-native-babel-preset'];
    delete packageJson.devDependencies['react-native-svg-transformer'];
    delete packageJson.devDependencies['react-test-renderer'];
    delete packageJson.devDependencies.typescript;
    // persist updated package.json
    fs.writeFileSync(packageJsonPath, `${JSON.stringify(packageJson, null, 2)}\n`, // keep the new line at the end of the file
    {
        encoding: 'utf-8',
    });
    // persist updated babel.config.js
    fs.writeFileSync(path.join(process.cwd(), 'babel.config.js'), newBabelConfig, {
        encoding: 'utf-8',
    });
    // persist updated babel.config.js
    fs.writeFileSync(path.join(process.cwd(), 'metro.config.js'), newMetroConfig, {
        encoding: 'utf-8',
    });
}
const newBabelConfig = `module.exports = {
  presets: ['@shopify/shop-minis-runtime/babel-preset'],
}
`;
const newMetroConfig = `const {
  getMinisMetroConfig,
} = require('@shopify/shop-minis-runtime/metro-config')

module.exports = getMinisMetroConfig()
`;
const releaseNotes = [
    'Upgrade @shopify/shop-minis-runtime',
    'Replace custom babel config with minis preset',
    'Replace custom metro config with minis metro config',
    'Remove dependencies that became unused after moving metro and babel config to the runtime package',
];
const exports = {
    releaseNotes,
    applyUpgrade,
    version: new SemVer('0.0.58'),
};
export default exports;
//# sourceMappingURL=v0-0-58.js.map